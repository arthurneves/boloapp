{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1>Logs de Atividade</h1>

    <!-- Formulário de Filtro -->
    <form method="GET" action="{{ url_for('log.listar_logs') }}" class="mb-4">
        <div class="row">
            <div class="col-md-3">
                {{ form.usuario_autor.label(class="form-label") }}
                {{ form.usuario_autor(class="form-select") }}
            </div>
            <div class="col-md-3">
                {{ form.usuario_afetado.label(class="form-label") }}
                {{ form.usuario_afetado(class="form-select") }}
            </div>
            <div class="col-md-2">
                {{ form.acao.label(class="form-label") }}
                {{ form.acao(class="form-select") }}
            </div>
            <div class="col-md-2">
                {{ form.data_inicio.label(class="form-label") }}
                {{ form.data_inicio(class="form-control", type="date") }}
            </div>
            <div class="col-md-2">
                {{ form.data_fim.label(class="form-label") }}
                {{ form.data_fim(class="form-control", type="date") }}
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </div>
    </form>

    <!-- Tabela de Logs -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>
                    <a href="{{ url_for('log.listar_logs', 
                        sort='id_log', 
                        order='desc' if sort_by != 'id_log' or sort_order == 'asc' else 'asc',
                        usuario_autor=request.args.get('usuario_autor', 0),
                        usuario_afetado=request.args.get('usuario_afetado', 0),
                        acao=request.args.get('acao', ''),
                        data_inicio=request.args.get('data_inicio', ''),
                        data_fim=request.args.get('data_fim', '')) }}">
                        ID Log
                    </a>
                </th>
                <th>
                    <a href="{{ url_for('log.listar_logs', 
                        sort='id_usuario_autor', 
                        order='desc' if sort_by != 'id_usuario_autor' or sort_order == 'asc' else 'asc',
                        usuario_autor=request.args.get('usuario_autor', 0),
                        usuario_afetado=request.args.get('usuario_afetado', 0),
                        acao=request.args.get('acao', ''),
                        data_inicio=request.args.get('data_inicio', ''),
                        data_fim=request.args.get('data_fim', '')) }}">
                        Usuário Autor
                    </a>
                </th>
                <th>
                    <a href="{{ url_for('log.listar_logs', 
                        sort='id_usuario_afetado', 
                        order='desc' if sort_by != 'id_usuario_afetado' or sort_order == 'asc' else 'asc',
                        usuario_autor=request.args.get('usuario_autor', 0),
                        usuario_afetado=request.args.get('usuario_afetado', 0),
                        acao=request.args.get('acao', ''),
                        data_inicio=request.args.get('data_inicio', ''),
                        data_fim=request.args.get('data_fim', '')) }}">
                        Usuário Afetado
                    </a>
                </th>
                <th>
                    <a href="{{ url_for('log.listar_logs', 
                        sort='acao_log', 
                        order='desc' if sort_by != 'acao_log' or sort_order == 'asc' else 'asc',
                        usuario_autor=request.args.get('usuario_autor', 0),
                        usuario_afetado=request.args.get('usuario_afetado', 0),
                        acao=request.args.get('acao', ''),
                        data_inicio=request.args.get('data_inicio', ''),
                        data_fim=request.args.get('data_fim', '')) }}">
                        Ação
                    </a>
                </th>
                <th>
                    <a href="{{ url_for('log.listar_logs', 
                        sort='data_criacao', 
                        order='desc' if sort_by != 'data_criacao' or sort_order == 'asc' else 'asc',
                        usuario_autor=request.args.get('usuario_autor', 0),
                        usuario_afetado=request.args.get('usuario_afetado', 0),
                        acao=request.args.get('acao', ''),
                        data_inicio=request.args.get('data_inicio', ''),
                        data_fim=request.args.get('data_fim', '')) }}">
                        Data Criação
                    </a>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.id_log }}</td>
                <td>{{ log.usuario_autor.nome }}</td>
                <td>{{ log.usuario_afetado.nome }}</td>
                <td>{{ log.acao_log }}</td>
                <td>{{ log.data_criacao.strftime('%d/%m/%Y %H:%M:%S') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Paginação -->
    <nav aria-label="Navegação de logs">
        <ul class="pagination">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('log.listar_logs', 
                    page=pagination.prev_num, 
                    sort=sort_by, 
                    order=sort_order,
                    usuario_autor=request.args.get('usuario_autor', 0),
                    usuario_afetado=request.args.get('usuario_afetado', 0),
                    acao=request.args.get('acao', ''),
                    data_inicio=request.args.get('data_inicio', ''),
                    data_fim=request.args.get('data_fim', '')) }}">
                    Anterior
                </a>
            </li>
            {% endif %}

            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    {% if page_num == pagination.page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('log.listar_logs', 
                                page=page_num, 
                                sort=sort_by, 
                                order=sort_order,
                                usuario_autor=request.args.get('usuario_autor', 0),
                                usuario_afetado=request.args.get('usuario_afetado', 0),
                                acao=request.args.get('acao', ''),
                                data_inicio=request.args.get('data_inicio', ''),
                                data_fim=request.args.get('data_fim', '')) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('log.listar_logs', 
                    page=pagination.next_num, 
                    sort=sort_by, 
                    order=sort_order,
                    usuario_autor=request.args.get('usuario_autor', 0),
                    usuario_afetado=request.args.get('usuario_afetado', 0),
                    acao=request.args.get('acao', ''),
                    data_inicio=request.args.get('data_inicio', ''),
                    data_fim=request.args.get('data_fim', '')) }}">
                    Próximo
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endblock %}
